name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
  ###############################################################################
  # ArgoCD ë°°í¬ íŠ¸ë¦¬ê±° (ë¡œì»¬ Kubernetes í™˜ê²½)
  ###############################################################################
  deploy:
    name: ðŸš€ ArgoCD ë°°í¬ íŠ¸ë¦¬ê±°
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸŽ¯ ArgoCD ë°°í¬ íŠ¸ë¦¬ê±°
        run: |
          echo "## ðŸš€ ArgoCD ë°°í¬ íŠ¸ë¦¬ê±°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ë°°í¬í•  ì´ë¯¸ì§€" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ ArgoCD ë™ìž‘ ë°©ì‹" >> $GITHUB_STEP_SUMMARY
          echo "1. **ìžë™ ê°ì§€**: ArgoCDê°€ ìƒˆë¡œìš´ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ê°ì§€" >> $GITHUB_STEP_SUMMARY
          echo "2. **ë™ê¸°í™”**: ë¡œì»¬ Kubernetes í´ëŸ¬ìŠ¤í„°ì— ìžë™ ë°°í¬" >> $GITHUB_STEP_SUMMARY
          echo "3. **ëª¨ë‹ˆí„°ë§**: ArgoCD UIì—ì„œ ë°°í¬ ìƒíƒœ í™•ì¸ ê°€ëŠ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ArgoCD ì„¤ì • í•„ìš”ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
          echo "- ArgoCD Application ìƒì„±" >> $GITHUB_STEP_SUMMARY
          echo "- Git Repository ì—°ë™" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-Sync í™œì„±í™”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **ArgoCDê°€ ìžë™ìœ¼ë¡œ ë°°í¬ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤!**" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”— ArgoCD ì ‘ì† ì •ë³´
        run: |
          echo "## ðŸ”— ArgoCD ì ‘ì† ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë¡œì»¬ í™˜ê²½" >> $GITHUB_STEP_SUMMARY
          echo "- ArgoCD UI: http://localhost:8080" >> $GITHUB_STEP_SUMMARY
          echo "- Admin ê³„ì •: admin / ì´ˆê¸° íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ í•„ìš”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### kubectl ëª…ë ¹ì–´" >> $GITHUB_STEP_SUMMARY
          echo "```bash" >> $GITHUB_STEP_SUMMARY
          echo "# ArgoCD ìƒíƒœ í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get applications -n argocd" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# ë°°í¬ ìƒíƒœ í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n searchpilot" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“Š ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        if: success()
        run: |
          echo "## ðŸŽ‰ CD íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCDê°€ ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¥¼ ê°ì§€í•˜ì—¬ ìžë™ ë°°í¬ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë‹¤ìŒ ë‹¨ê³„" >> $GITHUB_STEP_SUMMARY
          echo "1. ArgoCD UIì—ì„œ ë°°í¬ ì§„í–‰ìƒí™© í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "2. ë¡œì»¬ Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ ì„œë¹„ìŠ¤ í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "3. ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ì† í…ŒìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
