name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
  ###############################################################################
  # 1. í…ŒìŠ¤íŠ¸ ë‹¨ê³„ - Unit í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ (ë¹ ë¥¸ ê²€ì¦)
  # TODO: ì¶”í›„ í†µí•©/ì„±ëŠ¥/E2E í…ŒìŠ¤íŠ¸ ì¶”ê°€ ì˜ˆì •
  ###############################################################################
  test:
    name: ðŸ§ª Unit í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (~300ê±´)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ðŸ Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: ðŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ë³‘ë ¬ ì‹¤í–‰)
        run: |
          cd backend
          pytest tests/unit -n auto -v --tb=short --junit-xml=../test-results/unit-tests.xml
      
      - name: ðŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
      
      - name: âœ… í…ŒìŠ¤íŠ¸ ìš”ì•½
        if: always()
        run: |
          echo "## í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ~300ê±´" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Unit í…ŒìŠ¤íŠ¸ ì™„ë£Œ!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ í†µí•©/ì„±ëŠ¥/E2E í…ŒìŠ¤íŠ¸ëŠ” ì¶”í›„ í™œì„±í™” ì˜ˆì •" >> $GITHUB_STEP_SUMMARY

  ###############################################################################
  # 2. ë¹Œë“œ ë° í‘¸ì‹œ ë‹¨ê³„
  ###############################################################################
  build:
    name: ðŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ðŸ” Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“ Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: ðŸ”¨ Backend ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
      
      - name: ðŸ“ Frontend ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: ðŸ”¨ Frontend ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}

  ###############################################################################
  # 3. Canary ë°°í¬ ë‹¨ê³„ (Argo Rollouts íŠ¸ë¦¬ê±°)
  ###############################################################################
  deploy:
    name: ðŸš€ Canary ë°°í¬
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: âš™ï¸ kubectl ì„¤ì •
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: ðŸ” Kubernetes í´ëŸ¬ìŠ¤í„° ì¸ì¦
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig
      
      - name: ðŸš€ Argo Rolloutsë¡œ ë°°í¬ íŠ¸ë¦¬ê±°
        run: |
          export KUBECONFIG=kubeconfig
          
          # Update backend rollout
          kubectl set image rollout/backend \
            backend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }} \
            -n searchpilot
          
          # Update frontend deployment
          kubectl set image deployment/frontend \
            frontend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }} \
            -n searchpilot
          
          echo "âœ… Canary ë°°í¬ ì‹œìž‘ë¨"
          echo "   - 10% â†’ 30% â†’ 60% â†’ 100% íŠ¸ëž˜í”½ ì „í™˜"
          echo "   - ê° ë‹¨ê³„ë§ˆë‹¤ ìžë™ ë©”íŠ¸ë¦­ ë¶„ì„"
          echo "   - ì´ìƒ ê°ì§€ ì‹œ ìžë™ ë¡¤ë°±"
      
      - name: ðŸ“Š ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
        run: |
          export KUBECONFIG=kubeconfig
          kubectl argo rollouts status backend -n searchpilot --timeout 10m
      
      - name: ðŸŽ‰ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        if: success()
        run: |
          echo "## ðŸŽ‰ Canary ë°°í¬ ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ëª¨ë“  ë©”íŠ¸ë¦­ ë¶„ì„ì„ í†µê³¼í•˜ì—¬ ì•ˆì •ì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
        if: failure()
        run: |
          export KUBECONFIG=kubeconfig
          kubectl argo rollouts abort backend -n searchpilot
          echo "âŒ ë°°í¬ ì‹¤íŒ¨. ìžë™ ë¡¤ë°± ìˆ˜í–‰ë¨." >> $GITHUB_STEP_SUMMARY

