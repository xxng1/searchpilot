name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY_GHCR: ghcr.io
  REGISTRY_DOCKERHUB: docker.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend
  DOCKERHUB_USERNAME: xxng1

jobs:
  ###############################################################################
  # 1. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (ê°€ìž¥ ë¨¼ì € ì‹¤í–‰)
  ###############################################################################
  performance-test:
    name: âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (200ê±´)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd backend
          pip install -r requirements.txt

      - name: ðŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (300ê±´)
        run: |
          cd backend
          pytest tests/unit -n 16 -v --tb=short --junit-xml=../test-results/unit-tests.xml

      - name: ðŸ“Š ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results/

  ###############################################################################
  # 2. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  ###############################################################################
  unit-test:
    name: ðŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (300ê±´)
    runs-on: ubuntu-latest
    needs: performance-test
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd backend
          pip install -r requirements.txt

      - name: ðŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (300ê±´)
        run: |
          cd backend
          pytest tests/unit -n 16 -v --tb=short --junit-xml=../test-results/unit-tests.xml

      - name: ðŸ“Š ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results/

  ###############################################################################
  # 3. í†µí•© í…ŒìŠ¤íŠ¸
  ###############################################################################
  integration-test:
    name: ðŸ”— í†µí•© í…ŒìŠ¤íŠ¸ (400ê±´)
    runs-on: ubuntu-latest
    needs: unit-test
    
    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd backend
          pip install -r requirements.txt

      - name: ðŸ”— í†µí•© í…ŒìŠ¤íŠ¸ (400ê±´)
        env:
          DATABASE_URL: mysql+aiomysql://searchuser:searchpass@localhost:3306/searchpilot
        run: |
          cd backend
          pytest tests/integration -n 8 -v --tb=short --junit-xml=../test-results/integration-tests.xml

      - name: ðŸ“Š í†µí•© í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: test-results/


  ###############################################################################
  # 2. ë¹Œë“œ ë° í‘¸ì‹œ ë‹¨ê³„
  ###############################################################################
  build:
    name: ðŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: [performance-test, unit-test, integration-test]
    if: github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ” GHCR ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” DockerHub ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKERHUB }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ“ Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (GHCR)
        id: meta-backend-ghcr
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ“ Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (DockerHub)
        id: meta-backend-dockerhub
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/searchpilot-backend
          tags: |
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ”¨ Backend ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ steps.meta-backend-ghcr.outputs.tags }}
            ${{ steps.meta-backend-dockerhub.outputs.tags }}
          labels: ${{ steps.meta-backend-ghcr.outputs.labels }}

      - name: ðŸ“ Frontend ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (GHCR)
        id: meta-frontend-ghcr
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ“ Frontend ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (DockerHub)
        id: meta-frontend-dockerhub
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/searchpilot-frontend
          tags: |
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ”¨ Frontend ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ steps.meta-frontend-ghcr.outputs.tags }}
            ${{ steps.meta-frontend-dockerhub.outputs.tags }}
          labels: ${{ steps.meta-frontend-ghcr.outputs.labels }}

      - name: ðŸŽ‰ ë¹Œë“œ ì™„ë£Œ ì•Œë¦¼
        if: success()
        run: |
          echo "## ðŸŽ‰ CI íŒŒì´í”„ë¼ì¸ ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ë¹Œë“œëœ ì´ë¯¸ì§€ (GHCR)" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME_BACKEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ë¹Œë“œëœ ì´ë¯¸ì§€ (DockerHub)" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ secrets.DOCKER_USERNAME }}/searchpilot-backend:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ secrets.DOCKER_USERNAME }}/searchpilot-frontend:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ì´ë¯¸ì§€ ë§í¬" >> $GITHUB_STEP_SUMMARY
          echo "- [GHCR Backend](https://github.com/${{ github.repository }}/pkgs/container/backend)" >> $GITHUB_STEP_SUMMARY
          echo "- [GHCR Frontend](https://github.com/${{ github.repository }}/pkgs/container/frontend)" >> $GITHUB_STEP_SUMMARY
          echo "- [DockerHub Backend](https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/searchpilot-backend)" >> $GITHUB_STEP_SUMMARY
          echo "- [DockerHub Frontend](https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/searchpilot-frontend)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **ArgoCDì—ì„œ ìžë™ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ!**" >> $GITHUB_STEP_SUMMARY

      - name: âŒ ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "## âŒ CI íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
